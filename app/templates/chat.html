{% extends "base.html" %}

{% block title %}GenPreventiva - Preventivi AI{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50" x-data="chatApp()">
    <div class="flex h-screen">

        <!-- Sidebar con Storico Sessioni -->
        <aside class="w-64 bg-gray-900 flex flex-col">
            <!-- Header Sidebar -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">G</span>
                        </div>
                        <span class="text-white font-semibold">GenPreventiva</span>
                    </div>
                </div>

                <!-- Nuova Chat -->
                <button @click="newChat()" class="w-full py-2 px-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg flex items-center justify-center gap-2 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span class="text-sm">Nuova Chat</span>
                </button>
            </div>

            <!-- Cerca Sessioni -->
            <div class="p-3 border-b border-gray-700">
                <div class="relative">
                    <input
                        type="text"
                        x-model="sessionSearch"
                        @input.debounce.300ms="loadSessions()"
                        placeholder="Cerca preventivi..."
                        class="w-full px-3 py-2 pl-9 bg-gray-800 border border-gray-700 rounded-lg text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
                    >
                    <svg class="w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>

            <!-- Lista Sessioni -->
            <div class="flex-1 overflow-y-auto p-2">
                <template x-for="sess in sessions" :key="sess.id">
                    <button
                        @click="loadSession(sess.id)"
                        class="w-full text-left p-3 rounded-lg mb-1 transition"
                        :class="sess.id === sessionId ? 'bg-gray-700' : 'hover:bg-gray-800'"
                    >
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-white truncate" x-text="sess.title || 'Nuova sessione'"></p>
                                <p class="text-xs text-gray-500 mt-1" x-text="formatDate(sess.created_at)"></p>
                            </div>
                            <span x-show="sess.message_count > 0" class="text-xs text-gray-600 ml-2" x-text="sess.message_count + ' msg'"></span>
                        </div>
                    </button>
                </template>
                <p x-show="sessions.length === 0" class="text-center text-gray-500 text-sm py-4">Nessun preventivo</p>
            </div>

            <!-- Footer Sidebar -->
            <div class="p-3 border-t border-gray-700">
                <!-- Stats Apprendimento -->
                <button @click="showKnowledgeModal()" class="w-full p-2 hover:bg-gray-800 rounded-lg flex items-center gap-3 transition mb-2">
                    <div class="w-8 h-8 bg-green-600/20 rounded-lg flex items-center justify-center">
                        <span class="text-green-400 font-bold text-xs" x-text="knowledgeCount">0</span>
                    </div>
                    <span class="text-gray-400 text-sm">Conoscenze apprese</span>
                </button>

                <!-- Logout -->
                <button @click="logout()" class="w-full p-2 hover:bg-gray-800 rounded-lg flex items-center gap-3 transition">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span class="text-gray-400 text-sm">Esci</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex">

            <!-- Panel Disegno (se presente) -->
            <div x-show="currentFile" x-transition class="w-1/3 bg-white border-r flex flex-col">
                <div class="p-4 border-b flex items-center justify-between">
                    <div>
                        <h3 class="font-medium text-gray-900" x-text="currentFile?.name || 'Disegno'"></h3>
                        <p class="text-xs text-gray-500">Clicca per ingrandire</p>
                    </div>
                    <button @click="setCurrentFile(null)" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 p-4 flex items-center justify-center bg-gray-50 overflow-auto">
                    <!-- Image preview -->
                    <template x-if="currentFileUrl && isImage(currentFile)">
                        <img :src="currentFileUrl" class="max-w-full max-h-full object-contain cursor-zoom-in" @click="window.open(currentFileUrl, '_blank')">
                    </template>
                    <!-- PDF placeholder -->
                    <template x-if="currentFile && !isImage(currentFile)">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto text-red-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-sm text-gray-500" x-text="currentFile?.name"></p>
                            <p class="text-xs text-gray-400 mt-1">PDF - clicca per aprire</p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Chat -->
            <div class="flex-1 flex flex-col">

                <!-- Header -->
                <div class="bg-white border-b px-6 py-3 flex items-center justify-between">
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">GenPreventiva</h1>
                        <p class="text-xs text-gray-500">Analista Tecnico AI - Impara i tuoi costi</p>
                    </div>

                    <!-- Indicatore apprendimento -->
                    <div x-show="justLearned" x-transition class="flex items-center gap-2 bg-green-50 text-green-700 px-3 py-1.5 rounded-full text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span x-text="justLearned"></span>
                    </div>
                </div>

                <!-- Messages -->
                <div class="flex-1 overflow-y-auto p-6 space-y-4" id="chatArea">

                    <!-- Welcome -->
                    <div x-show="messages.length === 0" class="h-full flex flex-col items-center justify-center">
                        <div class="w-20 h-20 bg-primary-100 rounded-full flex items-center justify-center mb-6">
                            <svg class="w-10 h-10 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Ciao! Sono il tuo Analista Tecnico</h2>
                        <p class="text-gray-600 text-center max-w-md mb-6">
                            Carica un disegno e dimmi che tipo di lavorazione vuoi.
                            Insegnami i tuoi costi e tempi - piu mi correggi, piu divento preciso!
                        </p>
                        <div class="flex flex-wrap justify-center gap-2 text-sm">
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">CNC</span>
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">Laser</span>
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">Stampa 3D</span>
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">Lamiera</span>
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">Saldatura</span>
                        </div>
                    </div>

                    <!-- Messages List -->
                    <template x-for="(msg, i) in messages" :key="i">
                        <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                            <div class="max-w-2xl">
                                <!-- File badges (supporta sia singolo che multipli) -->
                                <div x-show="msg.file || (msg.files && msg.files.length > 0)" class="mb-1 flex flex-wrap gap-1 justify-end">
                                    <!-- Singolo file (retrocompatibilità) -->
                                    <template x-if="msg.file && !msg.files">
                                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 rounded text-xs text-gray-600">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                            </svg>
                                            <span x-text="msg.file"></span>
                                        </span>
                                    </template>
                                    <!-- Multipli file -->
                                    <template x-for="(fname, fi) in (msg.files || [])" :key="fi">
                                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 rounded text-xs text-gray-600">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                            </svg>
                                            <span x-text="fname"></span>
                                        </span>
                                    </template>
                                </div>
                                <!-- Message bubble -->
                                <div
                                    class="rounded-2xl px-4 py-3"
                                    :class="msg.role === 'user' ? 'bg-primary-600 text-white' : 'bg-white shadow-sm border'"
                                >
                                    <div class="whitespace-pre-wrap" x-html="formatMsg(msg.content)"></div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Loading -->
                    <div x-show="loading" class="flex justify-start">
                        <div class="bg-white shadow-sm border rounded-2xl px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 bg-primary-600 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-primary-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-primary-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                <span class="text-gray-500 ml-2">Analizzo...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input -->
                <div class="bg-white border-t p-4">
                    <!-- Multi-file preview grid -->
                    <div x-show="pendingFiles.length > 0" class="mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-500" x-text="`${pendingFiles.length}/5 file - Seleziona quali inviare`"></span>
                            <button @click="clearPendingFiles()" class="text-xs text-red-500 hover:text-red-700">Rimuovi tutti</button>
                        </div>
                        <div class="grid grid-cols-5 gap-2">
                            <template x-for="(pf, idx) in pendingFiles" :key="idx">
                                <div class="relative group">
                                    <!-- Thumbnail -->
                                    <div
                                        class="aspect-square rounded-lg border-2 overflow-hidden cursor-pointer transition"
                                        :class="pf.selected ? 'border-primary-500 ring-2 ring-primary-200' : 'border-gray-200 opacity-50'"
                                        @click="pf.selected = !pf.selected"
                                    >
                                        <template x-if="pf.isImage">
                                            <img :src="pf.url" class="w-full h-full object-cover" :alt="pf.file.name">
                                        </template>
                                        <template x-if="!pf.isImage">
                                            <div class="w-full h-full bg-red-50 flex flex-col items-center justify-center">
                                                <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                                <span class="text-xs text-red-500 mt-1">PDF</span>
                                            </div>
                                        </template>
                                        <!-- Checkbox indicator -->
                                        <div class="absolute top-1 left-1">
                                            <div class="w-5 h-5 rounded border-2 flex items-center justify-center"
                                                 :class="pf.selected ? 'bg-primary-500 border-primary-500' : 'bg-white border-gray-300'">
                                                <svg x-show="pf.selected" class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Actions -->
                                    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                        <!-- Enlarge -->
                                        <button
                                            @click.stop="openLightbox(pf.url, pf.file.name)"
                                            class="w-6 h-6 bg-black/50 rounded flex items-center justify-center text-white hover:bg-black/70"
                                            title="Ingrandisci"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                                            </svg>
                                        </button>
                                        <!-- Remove -->
                                        <button
                                            @click.stop="removePendingFile(idx)"
                                            class="w-6 h-6 bg-red-500 rounded flex items-center justify-center text-white hover:bg-red-600"
                                            title="Rimuovi"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <!-- Filename -->
                                    <p class="text-xs text-gray-500 truncate mt-1 text-center" x-text="pf.file.name"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="flex items-end gap-3">
                        <!-- Upload (multiple) -->
                        <label class="cursor-pointer p-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition relative" :class="{'opacity-50': pendingFiles.length >= 5}">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                            <input type="file" @change="selectFiles" accept=".pdf,.png,.jpg,.jpeg" multiple class="hidden" :disabled="pendingFiles.length >= 5">
                            <span x-show="pendingFiles.length > 0" class="absolute -top-1 -right-1 w-5 h-5 bg-primary-600 text-white text-xs rounded-full flex items-center justify-center" x-text="pendingFiles.filter(f=>f.selected).length"></span>
                        </label>

                        <!-- Text input -->
                        <div class="flex-1 relative">
                            <textarea
                                x-ref="messageInput"
                                x-model="input"
                                @keydown.enter.prevent="if(!$event.shiftKey) send()"
                                placeholder="Descrivi il pezzo o chiedi il preventivo..."
                                rows="1"
                                class="w-full px-4 py-3 pr-12 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"
                                :disabled="loading"
                            ></textarea>
                        </div>

                        <!-- Send -->
                        <button
                            @click="send()"
                            :disabled="loading || (!input.trim() && pendingFiles.filter(f=>f.selected).length === 0)"
                            class="p-3 bg-primary-600 hover:bg-primary-700 disabled:bg-gray-300 text-white rounded-xl transition"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Lightbox Modal per ingrandire immagini -->
    <div x-show="lightboxOpen" x-transition.opacity class="fixed inset-0 z-[60] flex items-center justify-center" style="display: none;">
        <!-- Overlay scuro -->
        <div class="fixed inset-0 bg-black/90" @click="closeLightbox()"></div>
        <!-- Contenuto -->
        <div class="relative z-10 max-w-[90vw] max-h-[90vh]">
            <!-- Header con nome file e chiudi -->
            <div class="absolute -top-10 left-0 right-0 flex items-center justify-between text-white">
                <span class="text-sm" x-text="lightboxName"></span>
                <button @click="closeLightbox()" class="text-white hover:text-gray-300">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <!-- Immagine o PDF -->
            <template x-if="lightboxUrl && lightboxName?.toLowerCase().endsWith('.pdf')">
                <div class="bg-white rounded-lg p-8 text-center">
                    <svg class="w-24 h-24 mx-auto text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p class="text-gray-700 mb-4" x-text="lightboxName"></p>
                    <a :href="lightboxUrl" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        Apri PDF
                    </a>
                </div>
            </template>
            <template x-if="lightboxUrl && !lightboxName?.toLowerCase().endsWith('.pdf')">
                <img :src="lightboxUrl" class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl" :alt="lightboxName">
            </template>
        </div>
        <!-- Navigazione con tastiera -->
        <div @keydown.escape.window="closeLightbox()"></div>
    </div>

    <!-- Modal Conoscenze Apprese -->
    <div x-show="knowledgeModalOpen" x-transition.opacity class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-black/50" @click="knowledgeModalOpen = false"></div>

            <!-- Modal Content -->
            <div class="relative bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                <div class="p-6 border-b flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Conoscenze Apprese</h2>
                        <p class="text-sm text-gray-500">L'AI ha imparato queste informazioni dalle tue correzioni</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="showAddKnowledgeForm = !showAddKnowledgeForm" class="px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Aggiungi
                        </button>
                        <button @click="knowledgeModalOpen = false" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <!-- Add Knowledge Form -->
                    <div x-show="showAddKnowledgeForm" x-transition class="bg-primary-50 rounded-xl p-4 mb-4 border border-primary-200">
                        <h3 class="font-medium text-gray-900 mb-3">Aggiungi nuova conoscenza</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Tipo</label>
                                <select x-model="newKnowledge.type" class="w-full px-3 py-2 border rounded-lg text-sm">
                                    <option value="costo">Costo</option>
                                    <option value="tempo">Tempo</option>
                                    <option value="macchina">Macchina</option>
                                    <option value="materiale">Materiale</option>
                                    <option value="processo">Processo</option>
                                    <option value="generale">Generale</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Titolo</label>
                                <input type="text" x-model="newKnowledge.title" placeholder="es. Costo orario laser" class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Contenuto</label>
                                <textarea x-model="newKnowledge.content" rows="2" placeholder="es. Il laser costa 80€/ora" class="w-full px-3 py-2 border rounded-lg text-sm"></textarea>
                            </div>
                            <div class="flex gap-2 justify-end">
                                <button @click="showAddKnowledgeForm = false; resetNewKnowledge()" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">Annulla</button>
                                <button @click="addKnowledge()" class="px-3 py-1.5 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700">Salva</button>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div x-show="knowledgeItems.length === 0 && !showAddKnowledgeForm" class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        <p class="text-gray-500">Nessuna conoscenza appresa ancora</p>
                        <p class="text-sm text-gray-400 mt-1">Correggi le stime dell'AI e imparera automaticamente</p>
                    </div>

                    <!-- Knowledge List -->
                    <div class="space-y-3">
                        <template x-for="item in knowledgeItems" :key="item.id">
                            <div class="bg-gray-50 rounded-xl p-4 border hover:border-primary-300 transition">
                                <!-- View Mode -->
                                <div x-show="editingId !== item.id">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="px-2 py-0.5 bg-primary-100 text-primary-700 rounded text-xs font-medium" x-text="item.type"></span>
                                                <span class="text-xs text-gray-400" x-text="new Date(item.created_at).toLocaleDateString('it')"></span>
                                            </div>
                                            <h4 class="font-medium text-gray-900" x-text="item.title"></h4>
                                            <p class="text-sm text-gray-600 mt-1" x-text="item.content"></p>
                                        </div>
                                        <div class="flex gap-1 ml-2">
                                            <button @click="startEdit(item)" class="text-gray-400 hover:text-primary-500" title="Modifica">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </button>
                                            <button @click="deleteKnowledge(item.id)" class="text-gray-400 hover:text-red-500" title="Elimina">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Edit Mode -->
                                <div x-show="editingId === item.id" class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Tipo</label>
                                        <select x-model="editForm.type" class="w-full px-3 py-2 border rounded-lg text-sm">
                                            <option value="costo">Costo</option>
                                            <option value="tempo">Tempo</option>
                                            <option value="macchina">Macchina</option>
                                            <option value="materiale">Materiale</option>
                                            <option value="processo">Processo</option>
                                            <option value="correzione">Correzione</option>
                                            <option value="generale">Generale</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Titolo</label>
                                        <input type="text" x-model="editForm.title" class="w-full px-3 py-2 border rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Contenuto</label>
                                        <textarea x-model="editForm.content" rows="3" class="w-full px-3 py-2 border rounded-lg text-sm"></textarea>
                                    </div>
                                    <div class="flex gap-2 justify-end">
                                        <button @click="cancelEdit()" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">Annulla</button>
                                        <button @click="saveEdit(item.id)" class="px-3 py-1.5 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700">Salva</button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function chatApp() {
    return {
        messages: [],
        input: '',
        pendingFiles: [],  // Array di {file, url, selected}
        currentFile: null,
        currentFileUrl: null,
        loading: false,
        knowledgeCount: 0,
        justLearned: null,
        sessionId: null,
        knowledgeModalOpen: false,
        knowledgeItems: [],
        editingId: null,
        editForm: { type: '', title: '', content: '' },
        // Sessioni
        sessions: [],
        sessionSearch: '',
        // Aggiungi conoscenza
        showAddKnowledgeForm: false,
        newKnowledge: { type: 'costo', title: '', content: '' },
        // Lightbox
        lightboxOpen: false,
        lightboxUrl: null,
        lightboxName: null,

        async init() {
            // Carica sessioni
            await this.loadSessions();
            // Carica o crea sessione attiva
            try {
                const session = await api.get('/api/sessions/active');
                this.sessionId = session.id;
                this.knowledgeCount = session.knowledge_extracted || 0;
                // Carica messaggi esistenti
                const msgs = await api.get(`/api/sessions/${session.id}/messages`);
                this.messages = msgs.map(m => ({
                    role: m.role,
                    content: m.content,
                    file: m.attached_file?.filename
                }));
                // Carica stats
                const stats = await api.get('/api/sessions/knowledge/stats');
                this.knowledgeCount = stats.total_knowledge_items || 0;
                this.scrollDown();
            } catch (e) {
                console.error(e);
            }
        },

        async newChat() {
            try {
                const session = await api.post('/api/sessions/new');
                this.sessionId = session.id;
                this.messages = [];
                this.setCurrentFile(null);
                await this.loadSessions();
            } catch (e) {
                console.error(e);
            }
        },

        async loadSessions() {
            try {
                const url = this.sessionSearch
                    ? `/api/sessions/?search=${encodeURIComponent(this.sessionSearch)}`
                    : '/api/sessions/';
                this.sessions = await api.get(url);
            } catch (e) {
                console.error('Error loading sessions:', e);
            }
        },

        async loadSession(id) {
            if (id === this.sessionId) return;
            try {
                // Attiva la sessione
                const session = await api.put(`/api/sessions/${id}/activate`);
                this.sessionId = session.id;
                this.knowledgeCount = session.knowledge_extracted || 0;
                // Carica messaggi
                const msgs = await api.get(`/api/sessions/${id}/messages`);
                this.messages = msgs.map(m => ({
                    role: m.role,
                    content: m.content,
                    file: m.attached_file?.filename
                }));
                this.setCurrentFile(null);
                await this.loadSessions();
                this.scrollDown();
            } catch (e) {
                console.error('Error loading session:', e);
            }
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const now = new Date();
            const diff = now - d;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (days === 0) return 'Oggi';
            if (days === 1) return 'Ieri';
            if (days < 7) return days + ' giorni fa';
            return d.toLocaleDateString('it');
        },

        selectFiles(e) {
            const files = Array.from(e.target.files);
            const MAX_FILES = 5;

            // Limita a 5 file totali
            const available = MAX_FILES - this.pendingFiles.length;
            if (available <= 0) {
                alert('Massimo 5 file alla volta');
                e.target.value = '';
                return;
            }

            const toAdd = files.slice(0, available);
            toAdd.forEach(file => {
                const url = URL.createObjectURL(file);
                this.pendingFiles.push({
                    file: file,
                    url: url,
                    selected: true,
                    isImage: this.isImageFile(file)
                });
            });

            if (files.length > available) {
                alert(`Aggiunti solo ${available} file (max 5)`);
            }
            e.target.value = '';
        },

        removePendingFile(index) {
            const item = this.pendingFiles[index];
            if (item?.url) {
                URL.revokeObjectURL(item.url);
            }
            this.pendingFiles.splice(index, 1);
        },

        clearPendingFiles() {
            this.pendingFiles.forEach(f => {
                if (f.url) URL.revokeObjectURL(f.url);
            });
            this.pendingFiles = [];
        },

        openLightbox(url, name) {
            this.lightboxUrl = url;
            this.lightboxName = name;
            this.lightboxOpen = true;
        },

        closeLightbox() {
            this.lightboxOpen = false;
            this.lightboxUrl = null;
            this.lightboxName = null;
        },

        isImageFile(file) {
            if (!file) return false;
            const name = file.name?.toLowerCase() || '';
            return name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg');
        },

        getSelectedFiles() {
            return this.pendingFiles.filter(f => f.selected).map(f => f.file);
        },

        async send() {
            const selectedFiles = this.getSelectedFiles();
            if (!this.input.trim() && selectedFiles.length === 0) return;

            const text = this.input.trim() || 'Analizza questi disegni e fammi un preventivo';
            const fileNames = selectedFiles.map(f => f.name);

            // Add user message
            this.messages.push({
                role: 'user',
                content: text,
                files: fileNames
            });

            this.input = '';
            this.loading = true;
            this.justLearned = null;
            this.scrollDown();

            // Show first file in panel
            if (selectedFiles.length > 0) {
                this.setCurrentFile(selectedFiles[0]);
            }

            try {
                // Ensure session exists
                if (!this.sessionId) {
                    const session = await api.post('/api/sessions/', { title: 'Chat' });
                    this.sessionId = session.id;
                }

                const formData = new FormData();
                formData.append('content', text);
                // Append tutti i file selezionati
                selectedFiles.forEach((file, i) => {
                    formData.append('files', file);
                });

                const res = await api.upload(`/api/sessions/${this.sessionId}/messages`, formData);

                // Add AI response
                this.messages.push({
                    role: 'assistant',
                    content: res.assistant_message.content
                });

                // Show learning indicator
                if (res.knowledge_learned?.length > 0) {
                    this.justLearned = 'Appreso: ' + res.knowledge_learned.map(k => k.title).join(', ');
                    this.knowledgeCount += res.knowledge_learned.length;
                    setTimeout(() => this.justLearned = null, 4000);
                }

                // Clear pending files after send
                this.clearPendingFiles();

            } catch (e) {
                this.messages.push({
                    role: 'assistant',
                    content: 'Errore: ' + (e.message || 'Riprova')
                });
            } finally {
                this.loading = false;
                this.scrollDown();
                // Mantieni focus sul campo input
                this.$nextTick(() => this.$refs.messageInput.focus());
            }
        },

        formatMsg(text) {
            return text
                .replace(/##\s*(.*)/g, '<h3 class="font-semibold text-base mt-3 mb-1">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.*)/gm, '<li class="ml-4">• $1</li>')
                .replace(/\n/g, '<br>');
        },

        scrollDown() {
            this.$nextTick(() => {
                const el = document.getElementById('chatArea');
                if (el) el.scrollTop = el.scrollHeight;
            });
        },

        logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        },

        isImage(file) {
            if (!file) return false;
            const name = file.name?.toLowerCase() || '';
            return name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg');
        },

        setCurrentFile(file) {
            // Revoke previous URL if exists
            if (this.currentFileUrl) {
                URL.revokeObjectURL(this.currentFileUrl);
            }
            this.currentFile = file;
            if (file) {
                this.currentFileUrl = URL.createObjectURL(file);
            } else {
                this.currentFileUrl = null;
            }
        },

        async showKnowledgeModal() {
            this.knowledgeModalOpen = true;
            try {
                const res = await api.get('/api/sessions/knowledge/list');
                this.knowledgeItems = res.items || [];
                this.knowledgeCount = res.total || 0;
            } catch (e) {
                console.error('Error loading knowledge:', e);
                this.knowledgeItems = [];
            }
        },

        async deleteKnowledge(id) {
            if (!confirm('Eliminare questa conoscenza?')) return;
            try {
                await api.delete(`/api/sessions/knowledge/${id}`);
                this.knowledgeItems = this.knowledgeItems.filter(k => k.id !== id);
                this.knowledgeCount = Math.max(0, this.knowledgeCount - 1);
            } catch (e) {
                console.error('Error deleting knowledge:', e);
            }
        },

        startEdit(item) {
            this.editingId = item.id;
            this.editForm = {
                type: item.type,
                title: item.title,
                content: item.content
            };
        },

        cancelEdit() {
            this.editingId = null;
            this.editForm = { type: '', title: '', content: '' };
        },

        async saveEdit(id) {
            try {
                const res = await api.put(`/api/sessions/knowledge/${id}`, {
                    knowledge_type: this.editForm.type,
                    title: this.editForm.title,
                    content: this.editForm.content
                });
                // Aggiorna item nella lista
                const idx = this.knowledgeItems.findIndex(k => k.id === id);
                if (idx !== -1) {
                    this.knowledgeItems[idx] = {
                        ...this.knowledgeItems[idx],
                        type: res.type,
                        title: res.title,
                        content: res.content
                    };
                }
                this.cancelEdit();
            } catch (e) {
                console.error('Error updating knowledge:', e);
                alert('Errore nel salvare le modifiche');
            }
        },

        resetNewKnowledge() {
            this.newKnowledge = { type: 'costo', title: '', content: '' };
        },

        async addKnowledge() {
            if (!this.newKnowledge.title.trim() || !this.newKnowledge.content.trim()) {
                alert('Inserisci titolo e contenuto');
                return;
            }
            try {
                const res = await api.post('/api/sessions/knowledge/create', {
                    knowledge_type: this.newKnowledge.type,
                    title: this.newKnowledge.title,
                    content: this.newKnowledge.content
                });
                // Aggiungi alla lista
                this.knowledgeItems.unshift({
                    id: res.id,
                    type: res.type,
                    title: res.title,
                    content: res.content,
                    created_at: res.created_at
                });
                this.knowledgeCount++;
                this.showAddKnowledgeForm = false;
                this.resetNewKnowledge();
            } catch (e) {
                console.error('Error adding knowledge:', e);
                alert('Errore nel salvare la conoscenza');
            }
        }
    }
}
</script>
{% endblock %}
