{% extends "base.html" %}

{% block title %}GenPreventiva - AI CNC Estimator{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50" x-data="chatApp()">
    <div class="flex h-screen">

        <!-- Sidebar Minimalista -->
        <aside class="w-16 bg-gray-900 flex flex-col items-center py-4">
            <!-- Logo -->
            <div class="w-10 h-10 bg-primary-600 rounded-lg flex items-center justify-center mb-6">
                <span class="text-white font-bold text-lg">G</span>
            </div>

            <!-- Nuova Chat -->
            <button @click="newChat()" class="w-10 h-10 bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center mb-4 transition" title="Nuova chat">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </button>

            <!-- Stats Apprendimento (clickable) -->
            <div class="flex-1"></div>
            <button @click="showKnowledgeModal()" class="mb-4 text-center group" title="Clicca per vedere le conoscenze apprese">
                <div class="w-10 h-10 bg-green-600/20 group-hover:bg-green-600/40 rounded-lg flex items-center justify-center transition cursor-pointer">
                    <span class="text-green-400 font-bold text-sm" x-text="knowledgeCount">0</span>
                </div>
                <span class="text-gray-500 text-xs mt-1 block">apprese</span>
            </button>

            <!-- Logout -->
            <button @click="logout()" class="w-10 h-10 hover:bg-gray-700 rounded-lg flex items-center justify-center transition" title="Esci">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex">

            <!-- Panel Disegno (se presente) -->
            <div x-show="currentFile" x-transition class="w-1/3 bg-white border-r flex flex-col">
                <div class="p-4 border-b flex items-center justify-between">
                    <div>
                        <h3 class="font-medium text-gray-900" x-text="currentFile?.name || 'Disegno'"></h3>
                        <p class="text-xs text-gray-500">Clicca per ingrandire</p>
                    </div>
                    <button @click="setCurrentFile(null)" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 p-4 flex items-center justify-center bg-gray-50 overflow-auto">
                    <!-- Image preview -->
                    <template x-if="currentFileUrl && isImage(currentFile)">
                        <img :src="currentFileUrl" class="max-w-full max-h-full object-contain cursor-zoom-in" @click="window.open(currentFileUrl, '_blank')">
                    </template>
                    <!-- PDF placeholder -->
                    <template x-if="currentFile && !isImage(currentFile)">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto text-red-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-sm text-gray-500" x-text="currentFile?.name"></p>
                            <p class="text-xs text-gray-400 mt-1">PDF - clicca per aprire</p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Chat -->
            <div class="flex-1 flex flex-col">

                <!-- Header -->
                <div class="bg-white border-b px-6 py-3 flex items-center justify-between">
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">GenPreventiva</h1>
                        <p class="text-xs text-gray-500">Analista Tecnico AI per preventivi CNC</p>
                    </div>

                    <!-- Indicatore apprendimento -->
                    <div x-show="justLearned" x-transition class="flex items-center gap-2 bg-green-50 text-green-700 px-3 py-1.5 rounded-full text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span x-text="justLearned"></span>
                    </div>
                </div>

                <!-- Messages -->
                <div class="flex-1 overflow-y-auto p-6 space-y-4" id="chatArea">

                    <!-- Welcome -->
                    <div x-show="messages.length === 0" class="h-full flex flex-col items-center justify-center">
                        <div class="w-20 h-20 bg-primary-100 rounded-full flex items-center justify-center mb-6">
                            <svg class="w-10 h-10 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Ciao! Sono il tuo Analista Tecnico</h2>
                        <p class="text-gray-600 text-center max-w-md mb-6">
                            Carica un disegno tecnico e ti faro un preventivo dettagliato.
                            Piu mi correggi, piu divento preciso.
                        </p>
                        <div class="flex flex-wrap justify-center gap-2 text-sm">
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">Analisi ISO/ASME</span>
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">Lista lavorazioni</span>
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">Tempi e costi</span>
                            <span class="px-3 py-1.5 bg-gray-100 rounded-full text-gray-600">Apprendimento continuo</span>
                        </div>
                    </div>

                    <!-- Messages List -->
                    <template x-for="(msg, i) in messages" :key="i">
                        <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                            <div class="max-w-2xl">
                                <!-- File badge -->
                                <div x-show="msg.file" class="mb-1">
                                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 rounded text-xs text-gray-600">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                        </svg>
                                        <span x-text="msg.file"></span>
                                    </span>
                                </div>
                                <!-- Message bubble -->
                                <div
                                    class="rounded-2xl px-4 py-3"
                                    :class="msg.role === 'user' ? 'bg-primary-600 text-white' : 'bg-white shadow-sm border'"
                                >
                                    <div class="whitespace-pre-wrap" x-html="formatMsg(msg.content)"></div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Loading -->
                    <div x-show="loading" class="flex justify-start">
                        <div class="bg-white shadow-sm border rounded-2xl px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 bg-primary-600 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-primary-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-primary-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                <span class="text-gray-500 ml-2">Analizzo...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input -->
                <div class="bg-white border-t p-4">
                    <!-- File preview -->
                    <div x-show="pendingFile" class="mb-3 p-3 bg-primary-50 border border-primary-200 rounded-lg flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            <span class="text-sm font-medium text-primary-700" x-text="pendingFile?.name"></span>
                        </div>
                        <button @click="pendingFile = null" class="text-primary-400 hover:text-primary-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-end gap-3">
                        <!-- Upload -->
                        <label class="cursor-pointer p-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                            <input type="file" @change="selectFile" accept=".pdf,.png,.jpg,.jpeg" class="hidden">
                        </label>

                        <!-- Text input -->
                        <div class="flex-1 relative">
                            <textarea
                                x-model="input"
                                @keydown.enter.prevent="if(!$event.shiftKey) send()"
                                placeholder="Descrivi il pezzo o chiedi il preventivo..."
                                rows="1"
                                class="w-full px-4 py-3 pr-12 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"
                                :disabled="loading"
                            ></textarea>
                        </div>

                        <!-- Send -->
                        <button
                            @click="send()"
                            :disabled="loading || (!input.trim() && !pendingFile)"
                            class="p-3 bg-primary-600 hover:bg-primary-700 disabled:bg-gray-300 text-white rounded-xl transition"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Conoscenze Apprese -->
    <div x-show="knowledgeModalOpen" x-transition.opacity class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-black/50" @click="knowledgeModalOpen = false"></div>

            <!-- Modal Content -->
            <div class="relative bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                <div class="p-6 border-b flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Conoscenze Apprese</h2>
                        <p class="text-sm text-gray-500">L'AI ha imparato queste informazioni dalle tue correzioni</p>
                    </div>
                    <button @click="knowledgeModalOpen = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <!-- Empty State -->
                    <div x-show="knowledgeItems.length === 0" class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        <p class="text-gray-500">Nessuna conoscenza appresa ancora</p>
                        <p class="text-sm text-gray-400 mt-1">Correggi le stime dell'AI e imparera automaticamente</p>
                    </div>

                    <!-- Knowledge List -->
                    <div class="space-y-3">
                        <template x-for="item in knowledgeItems" :key="item.id">
                            <div class="bg-gray-50 rounded-xl p-4 border hover:border-primary-300 transition">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-2 py-0.5 bg-primary-100 text-primary-700 rounded text-xs font-medium" x-text="item.type"></span>
                                            <span class="text-xs text-gray-400" x-text="new Date(item.created_at).toLocaleDateString('it')"></span>
                                        </div>
                                        <h4 class="font-medium text-gray-900" x-text="item.title"></h4>
                                        <p class="text-sm text-gray-600 mt-1" x-text="item.content"></p>
                                    </div>
                                    <button @click="deleteKnowledge(item.id)" class="text-gray-400 hover:text-red-500 ml-2" title="Elimina">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function chatApp() {
    return {
        messages: [],
        input: '',
        pendingFile: null,
        currentFile: null,
        currentFileUrl: null,
        loading: false,
        knowledgeCount: 0,
        justLearned: null,
        sessionId: null,
        knowledgeModalOpen: false,
        knowledgeItems: [],

        async init() {
            // Carica o crea sessione
            try {
                const session = await api.get('/api/sessions/active');
                this.sessionId = session.id;
                // Carica messaggi esistenti
                const msgs = await api.get(`/api/sessions/${session.id}/messages`);
                this.messages = msgs.map(m => ({
                    role: m.role,
                    content: m.content,
                    file: m.attached_file?.filename
                }));
                // Carica stats
                const stats = await api.get('/api/sessions/knowledge/stats');
                this.knowledgeCount = stats.total_knowledge_items || 0;
                this.scrollDown();
            } catch (e) {
                console.error(e);
            }
        },

        async newChat() {
            try {
                const session = await api.post('/api/sessions/', { title: 'Chat ' + new Date().toLocaleDateString('it') });
                this.sessionId = session.id;
                this.messages = [];
                this.setCurrentFile(null);
            } catch (e) {
                console.error(e);
            }
        },

        selectFile(e) {
            const file = e.target.files[0];
            if (file) {
                this.pendingFile = file;
            }
            e.target.value = '';
        },

        async send() {
            if (!this.input.trim() && !this.pendingFile) return;

            const text = this.input.trim() || 'Analizza questo disegno e fammi un preventivo';
            const file = this.pendingFile;

            // Add user message
            this.messages.push({
                role: 'user',
                content: text,
                file: file?.name
            });

            this.input = '';
            this.pendingFile = null;
            this.loading = true;
            this.justLearned = null;
            this.scrollDown();

            // Show file panel
            if (file) {
                this.setCurrentFile(file);
            }

            try {
                // Ensure session exists
                if (!this.sessionId) {
                    const session = await api.post('/api/sessions/', { title: 'Chat' });
                    this.sessionId = session.id;
                }

                const formData = new FormData();
                formData.append('content', text);
                if (file) formData.append('file', file);

                const res = await api.upload(`/api/sessions/${this.sessionId}/messages`, formData);

                // Add AI response
                this.messages.push({
                    role: 'assistant',
                    content: res.assistant_message.content
                });

                // Show learning indicator
                if (res.knowledge_learned?.length > 0) {
                    this.justLearned = 'Appreso: ' + res.knowledge_learned.map(k => k.title).join(', ');
                    this.knowledgeCount += res.knowledge_learned.length;
                    setTimeout(() => this.justLearned = null, 4000);
                }

            } catch (e) {
                this.messages.push({
                    role: 'assistant',
                    content: 'Errore: ' + (e.message || 'Riprova')
                });
            } finally {
                this.loading = false;
                this.scrollDown();
            }
        },

        formatMsg(text) {
            return text
                .replace(/##\s*(.*)/g, '<h3 class="font-semibold text-base mt-3 mb-1">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.*)/gm, '<li class="ml-4">â€¢ $1</li>')
                .replace(/\n/g, '<br>');
        },

        scrollDown() {
            this.$nextTick(() => {
                const el = document.getElementById('chatArea');
                if (el) el.scrollTop = el.scrollHeight;
            });
        },

        logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        },

        isImage(file) {
            if (!file) return false;
            const name = file.name?.toLowerCase() || '';
            return name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg');
        },

        setCurrentFile(file) {
            // Revoke previous URL if exists
            if (this.currentFileUrl) {
                URL.revokeObjectURL(this.currentFileUrl);
            }
            this.currentFile = file;
            if (file) {
                this.currentFileUrl = URL.createObjectURL(file);
            } else {
                this.currentFileUrl = null;
            }
        },

        async showKnowledgeModal() {
            this.knowledgeModalOpen = true;
            try {
                const res = await api.get('/api/sessions/knowledge/list');
                this.knowledgeItems = res.items || [];
                this.knowledgeCount = res.total || 0;
            } catch (e) {
                console.error('Error loading knowledge:', e);
                this.knowledgeItems = [];
            }
        },

        async deleteKnowledge(id) {
            if (!confirm('Eliminare questa conoscenza?')) return;
            try {
                await api.delete(`/api/sessions/knowledge/${id}`);
                this.knowledgeItems = this.knowledgeItems.filter(k => k.id !== id);
                this.knowledgeCount = Math.max(0, this.knowledgeCount - 1);
            } catch (e) {
                console.error('Error deleting knowledge:', e);
            }
        }
    }
}
</script>
{% endblock %}
